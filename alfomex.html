<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personaliza tu Alfombra - Alfomex</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      :root {
        --primary: #ffcc00;
        --secondary: #003366;
        --accent: #333;
        --bg: #f5f5f5;
        --card-bg: #ffffff;
        --shadow: rgba(0, 0, 0, 0.1);
      }

      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      body {
        font-family: 'Segoe UI', sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--accent);
      }

      header {
        background: #3b5998;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        text-align: center;
        flex: 1;
      }

      .header-left,
      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #menuBtn {
        font-size: 1.5rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
      }

      h2 {
        margin-top: 90px;
        font-size: 1.5rem;
        color: var(--secondary);
        text-align: center;
      }

      .alerta {
        text-align: center;
        margin: 20px auto;
        max-width: 90%;
        font-size: 0.95rem;
      }

      .botones-superiores {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .botones-superiores button,
      .plantilla-btn-container button {
        padding: 12px 25px;
        font-weight: bold;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #003366;
        color: white;
        transition: background 0.3s ease;
      }

      .botones-superiores button:hover,
      .plantilla-btn-container button:hover {
        background: #ffcc00;
        color: black;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: nowrap;
        flex-direction: row;
      }

      .controls button {
        background-color: #003366 !important;
        color: white !important;
        font-size: 1.2rem;
        padding: 12px;
        border: none;
        border-radius: 6px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
        user-select: none;
      }

      .controls button:hover,
      .controls button:focus,
      .controls button:focus-visible {
        background-color: #003366 !important;
        color: white !important;
        outline: no
      }

      .controls button:active {
        background-color: var(--primary);
        color: black;
      }

      .upload-btn:hover, .controls button:hover, #añadirCarrito:hover {
        background: var(--primary);
        color: black;
      }

      .contenedor-principal {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
        margin: 30px auto;
        max-width: 1200px;
        padding: 0 20px;
        box-sizing: border-box;
      }

      canvas {
        width: 500px !important;
        height: 500px !important;
        max-width: unset;
        max-height: unset;
        display: block;
      }

      .canvas-wrapper {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
      }

      .lateral {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
      }

      #resultado,
      #totalFinal {
        width: 100%;
        max-width: 500px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        text-align: left;
      }

      #totalFinal {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0055cc;
        text-align: center;
      }

      #añadirCarrito {
        width: 100%;
        max-width: 500px;
        margin: 20px auto;
        padding: 15px;
        font-size: 1rem;
        background-color: #003366;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
        display: block;
      }

      #resultado strong {
        display: block;
        margin-top: 10px;
        font-size: 1.2rem;
        color: var(--secondary);
      }

      #colorDetalle div {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }

      #colorDetalle div div {
        width: 25px;
        height: 25px;
        border: 1px solid #000;
        margin-right: 10px;
      }

      .total-final {
        font-size: 1.3rem;
        color: #0055cc;
        font-weight: bold;
        text-align: center;
      }

      .social-links {
        margin: 40px auto;
        text-align: center;
      }

      .social-links a {
        margin: 0 15px;
        font-size: 1.5rem;
        color: var(--accent);
        transition: transform 0.3s ease;
      }

      .social-links a:hover {
        transform: scale(1.2);
      }

      .icon-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        padding: 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
      }

      .btn-perfil {
        background: white;
        color: #3b5998;
      }

      .btn-logout {
        background: crimson;
        color: white;
      }

      .btn-perfil i, .btn-logout i {
        pointer-events: none;
      }

      .cart-panel {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100%;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        transition: right 0.3s ease;
        padding: 20px;
        overflow-y: auto;
      }

      .cart-panel.open {
        right: 0;
      }

      .cart-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: none;
      }

      .cart-overlay.active {
        display: block;
      }

      .sidenav {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        background-color: #3b5998;
        padding-top: 60px;
        padding-left: 15px;
        transition: left 0.3s ease;
        z-index: 9999;
        box-sizing: border-box;
      }

      .sidenav.open {
        left: 0;
      }

      .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 22px;
        color: white;
        display: block;
        transition: 0.3s;
      }

      .sidenav a:hover {
        color: #ddd;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .dropdown-menu {
        display: none;
        border: 1px solid #ccc;
        padding: 10px;
        background: white;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
        width: 100%;
      }

      .dropdown-menu.show {
        display: block;
      }

      .categoria {
        margin-bottom: 15px;
      }

      .categoria h4 {
        margin-bottom: 5px;
        font-size: 16px;
      }

      .categoria img {
        width: 100px;
        height: auto;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.2s;
      }

      .categoria img:hover {
        border-color: #000;
      }

      .plantillas-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #ccc;
        border-radius: 10px;
        padding: 20px;
        z-index: 10000;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .plantillas-modal.show {
        display: block;
      }

      .plantillas-modal h3 {
        margin-top: 0;
        text-align: center;
        color: var(--secondary);
      }

      .plantillas-modal .categoria {
        margin-bottom: 20px;
      }

      .plantillas-modal .categoria h4 {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: #333;
      }

      .plantillas-modal .categoria img {
        width: 100px;
        height: auto;
        margin: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.2s;
      }

      .plantillas-modal .categoria img:hover {
        border-color: var(--secondary);
      }

      .modal-overlay-plantillas {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
      }

      .modal-overlay-plantillas.active {
        display: block;
      }

      h2, .alerta, .plantilla-btn-container {
        text-align: center;
        width: 100%;
      }

      .plantilla-btn-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }

      .plantilla-btn-container button {
        background: #003366;
        color: white;
        border: none;
        padding: 12px 25px;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .plantilla-btn-container button:hover {
        background: #ffcc00;
        color: black;
      }

      @media (max-width: 600px) {
        .controls {
          flex-direction: row;
          flex-wrap: nowrap;
        }

        .controls button {
          width: 40px;
          height: 40px;
          font-size: 1rem;
        }

        h2 {
          font-size: 1.2rem;
        }

        .alerta {
          font-size: 0.95rem;
          padding: 12px;
        }

        .controls button,
        #añadirCarrito,
        .upload-btn {
          width: 90%;
          margin: 8px auto;
        }
      }

      @media (min-width: 768px) {
        .contenedor-principal {
          flex-wrap: nowrap;
          align-items: flex-start;
        }

        .lateral {
          max-width: 400px;
          margin-left: 40px;
        }

        #resultado,
        #totalFinal,
        #añadirCarrito {
          margin-left: 0;
          margin-right: 0;
        }

        canvas {
          width: 500px;
          height: 500px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <button id="menuBtn" onclick="openNav()">☰</button>
        <button id="cartBtn" title="Carrito" class="icon-btn btn-perfil">
          <i class="fas fa-shopping-cart"></i>
        </button>
      </div>
      <div class="logo">ALFOMEX</div>
      <nav class="header-right" id="navOptions">
        <span style="color: white;">Cargando...</span>
      </nav>
    </header>
    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">×</a>
      <a href="#">Categorías</a>
    </div>
    <div class="modal-overlay" id="modalOverlay"></div>
    <!-- Firebase App, Auth y Firestore -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyDPdVE3_R_ZsjBOZfa4bc9sMgBsLoDLlLc",
        authDomain: "alfomex-f4efa.firebaseapp.com",
        projectId: "alfomex-f4efa",
        storageBucket: "alfomex-f4efa.appspot.com",
        messagingSenderId: "1090528818564",
        appId: "1:1090528818564:web:dac6cb3333a2ee443919d1"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      // Espera a que el DOM esté cargado antes de acceder a elementos
      window.addEventListener("DOMContentLoaded", () => {
        onAuthStateChanged(auth, (user) => {
          if (!user) {
            window.location.href = "index.html";
            return;
          }
          const nav = document.getElementById("navOptions");
          nav.innerHTML = `
            <button onclick="location.href='perfil.html'" title="Perfil" class="icon-btn btn-perfil">
              <i class="fas fa-user-circle"></i>
            </button>
            <button onclick="cerrarSesion()" title="Cerrar sesión" class="icon-btn btn-logout">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          `;
        });
        window.cerrarSesion = async () => {
          await signOut(auth);
          window.location.href = "index.html";
        };
        window.openNav = () => {
          document.getElementById("mySidenav").classList.add("open");
          document.getElementById("modalOverlay").classList.add("active");
        };
        window.closeNav = () => {
          document.getElementById("mySidenav").classList.remove("open");
          document.getElementById("modalOverlay").classList.remove("active");
        };
        document.getElementById("modalOverlay").addEventListener("click", closeNav);
      });
      // Carrito
      window.toggleCart = (show) => {
        document.getElementById("cartPanel")?.classList.toggle("open", show);
        document.getElementById("cartOverlay")?.classList.toggle("active", show);
      };
      document.getElementById("cartBtn").addEventListener("click", () => toggleCart(true));
      window.agregarAlCarrito = (producto) => {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        carrito.push(producto);
        localStorage.setItem("carrito", JSON.stringify(carrito));
        actualizarVistaCarrito();
      };
      function actualizarVistaCarrito() {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        const lista = document.getElementById("cartItems");
        if (lista) lista.innerHTML = carrito.map(p => `<li>${p.nombre} - $${p.precio}</li>`).join('');
      }
      window.vaciarCarrito = () => {
        localStorage.removeItem("carrito");
        actualizarVistaCarrito();
      };
      // Firestore: cargar plantillas dinámicamente
      async function cargarPlantillasDesdeFirestore() {
        const modal = document.getElementById("modalPlantillas");
        const coleccion = collection(db, "plantillas");
        const querySnapshot = await getDocs(coleccion);
        let html = '<h3>Selecciona una plantilla</h3>';
        querySnapshot.forEach(doc => {
          const categoria = doc.id;
          const imagenes = doc.data().imagenes;
          html += `<div class=\"categoria\">\n            <h4>${categoria.toUpperCase()}</h4>`;
          imagenes.forEach(url => {
            html += `<img src=\"${url}\" data-url=\"${url}\" class=\"img-plantilla\">`;
          });
          html += `</div>`;
        });
        modal.innerHTML = html;
        document.querySelectorAll('.img-plantilla').forEach(img => {
          img.addEventListener('click', () => {
            cargarImagenAlLienzo(img.dataset.url);
          });
        });
      }
      window.abrirPlantillas = function() {
        cargarPlantillasDesdeFirestore();
        document.getElementById('modalPlantillas').classList.add('show');
        document.getElementById('fondoPlantillas').classList.add('active');
      };
      window.cerrarPlantillas = function() {
        document.getElementById('modalPlantillas').classList.remove('show');
        document.getElementById('fondoPlantillas').classList.remove('active');
      };
    </script>
    <h2>PERSONALIZA TU ALFOMBRA</h2>
    <div class="plantilla-btn-container">
      <button onclick="abrirPlantillas()">PLANTILLAS</button>
    </div>
    <input type="file" accept="image/png, image/jpeg" id="imgInput" style="display:none">
    <div class="contenedor-principal">
      <div>
        <div class="canvas-wrapper">
          <canvas id="lienzo"></canvas>
        </div>
        <div id="areaCubierta" style="margin-top: 10px; font-weight: bold;"></div>
        <div class="controls">
          <button 
            onmousedown="iniciarZoom(0.01)" 
            onmouseup="detenerZoom()" 
            onmouseleave="detenerZoom()" 
            ontouchstart="iniciarZoom(0.01)" 
            ontouchend="detenerZoom()" 
            title="Zoom +">
            <i class="fas fa-search-plus"></i>
          </button>
          <button onclick="centrarImagen()" title="Centrar">
            <i class="fas fa-compress-arrows-alt"></i>
          </button>
          <button 
            onmousedown="iniciarZoom(-0.01)" 
            onmouseup="detenerZoom()" 
            onmouseleave="detenerZoom()" 
            ontouchstart="iniciarZoom(-0.01)" 
            ontouchend="detenerZoom()" 
            title="Zoom -">
            <i class="fas fa-search-minus"></i>
          </button>
        </div>
      </div>
      <div class="lateral">
        <div id="resultado"></div>
        <div id="totalFinal" class="total-final"></div>
        <button id="añadirCarrito">AÑADIR AL CARRITO</button>
      </div>
    </div>
    <div class="social-links">
      <p>Sígueme en redes sociales:</p>
      <a href="https://www.facebook.com/profile.php?id=61559232980025" target="_blank"><i class="fab fa-facebook"></i></a>
      <a href="https://www.instagram.com/_alfomex/" target="_blank"><i class="fab fa-instagram"></i></a>
    </div>
    <script>
      const canvas = document.getElementById('lienzo');
      canvas.width = 500;
      canvas.height = 500;
      const ctx = canvas.getContext('2d');
      const imgInput = document.getElementById('imgInput');
      const resultado = document.getElementById('resultado');
      const colorDetalle = document.getElementById('colorDetalle');
      const totalFinal = document.getElementById('totalFinal');
      const pxPorCm = canvas.width / 100;
      let img = new Image();
      let dragging = false;
      let offsetX = 0, offsetY = 0;
      let imgX = 0, imgY = 0;
      let scale = 1;

      const COSTOS = {
        bolaEstambre: 35 * 4,
        metrosBola: 200,
        telaBase: 50 * 4,
        fieltro: 30 * 4,
        personalizacion: 399,
        tejidoCm: 10,
        distanciaPuntada: 0.3
      };

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i <= 100; i++) {
          const px = i * pxPorCm;
          ctx.fillStyle = i % 10 === 0 ? '#ddd' : '#eee';
          ctx.fillRect(px, 0, 1, canvas.height);
          ctx.fillRect(0, px, canvas.width, 1);
        }

        ctx.strokeStyle = '#999';
        for (let i = 0; i <= 100; i += 10) {
          const px = i * pxPorCm;
          ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvas.height); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(0, px); ctx.lineTo(canvas.width, px); ctx.stroke();
          
          ctx.fillStyle = '#000';
          ctx.font = '10px Arial';
          if (i !== 0) {
            ctx.fillText(`${i}cm`, px + 2, 12);
            ctx.fillText(`${i}cm`, 2, px + 10);
          } else {
            ctx.fillText(`0cm`, 2, 10);
          }
        }

        ctx.drawImage(img, imgX, imgY, img.width * scale, img.height * scale);

        // Calcular tamaño real de la imagen y mostrarlo
        const anchoCm = (img.width * scale) / pxPorCm;
        const altoCm = (img.height * scale) / pxPorCm;

        document.getElementById("areaCubierta").innerHTML =
        `<strong>Anchura:</strong> ${anchoCm.toFixed(2)} cm<br>` +
        `<strong>Altura:</strong> ${altoCm.toFixed(2)} cm`;
      }

      function agruparColor(r, g, b, mapa, tolerancia = 50) {
        for (let [key, _] of mapa.entries()) {
          const [r2, g2, b2] = key.split(',').map(Number);
          const distancia = Math.sqrt((r - r2) ** 2 + (g - g2) ** 2 + (b - b2) ** 2);
          if (distancia <= tolerancia) return key;
        }
        return `${r},${g},${b}`;
      }
      function calcularEstambre() {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(img, imgX, imgY, img.width * scale, img.height * scale);
        const imageData = tempCtx.getImageData(0, 0, canvas.width, canvas.height);
        let pixelCount = 0;
        for (let i = 0; i < imageData.data.length; i += 4) {
          if (imageData.data[i + 3] > 10) pixelCount++;
        }
        const totalPixels = canvas.width * canvas.height;
        const porcentaje = pixelCount / totalPixels;
        const areaCm2 = 10000 * porcentaje;
        const areaM2 = areaCm2 / 10000;
        const altoTejido = Math.sqrt(areaCm2);
        const lineas = altoTejido / COSTOS.distanciaPuntada;
        const estambreTotal = lineas * (1 / COSTOS.tejidoCm) * altoTejido;
        const bolas = estambreTotal / COSTOS.metrosBola;
        const costoEstambre = bolas * COSTOS.bolaEstambre;
        const costoTela = areaM2 * COSTOS.telaBase;
        const costoFieltro = areaM2 * COSTOS.fieltro;
        const costoFinal = costoEstambre + costoTela + costoFieltro + COSTOS.personalizacion;
        resultado.innerHTML = `<strong>Área cubierta:</strong> ${areaCm2.toFixed(2)} cm²<br>` +
                              `<strong>Costo Tela:</strong> $${costoTela.toFixed(2)} MXN<br>` +
                              `<strong>Costo Fieltro:</strong> $${costoFieltro.toFixed(2)} MXN<br>` +
                              `<strong>Costo Estambre Total:</strong> $${costoEstambre.toFixed(2)} MXN<br>` +
                              `<strong>Personalización:</strong> $${COSTOS.personalizacion.toFixed(2)} MXN`;
        calcularPorColor(imageData, totalPixels, costoFinal);
      }
      function ajustarCanvas() {
        const size = Math.min(window.innerWidth * 0.8, 500);
        canvas.width = size;
        canvas.height = size;
        draw(); // vuelve a dibujar la imagen si ya hay una cargada
        calcularEstambre(); // vuelve a calcular presupuesto si ya hay imagen
      }
      window.addEventListener("resize", ajustarCanvas);
      window.addEventListener("DOMContentLoaded", ajustarCanvas);

      function calcularPorColor(imageData, totalPixels, total) {
        const mapa = new Map();
        for (let i = 0; i < imageData.data.length; i += 4) {
          if (imageData.data[i + 3] < 10) continue;
          const r = imageData.data[i];
          const g = imageData.data[i + 1];
          const b = imageData.data[i + 2];
          const key = agruparColor(r, g, b, mapa, 50);
          mapa.set(key, (mapa.get(key) || 0) + 1);
        }
        const coloresUsados = [...mapa.entries()].filter(([_, count]) => count / totalPixels > 0.01);
        let detalle = '<strong>Estambre por color:</strong><br>';
        if (coloresUsados.length > 5) {
          detalle += `<span style="color:red;font-weight:bold">Demasiados colores detectados (${coloresUsados.length}). Contacta para personalización avanzada.</span>`;
          document.getElementById('añadirCarrito').disabled = true;
        } else {
          document.getElementById('añadirCarrito').disabled = false;
        }
        coloresUsados.forEach(([key, count]) => {
          const porcentaje = count / totalPixels;
          const areaCm2 = 10000 * porcentaje;
          const altoTejido = Math.sqrt(areaCm2);
          const lineas = altoTejido / COSTOS.distanciaPuntada;
          const estambre = lineas * (1 / COSTOS.tejidoCm) * altoTejido;
          const bolas = estambre / COSTOS.metrosBola;
          const costo = bolas * COSTOS.bolaEstambre;
          const [r, g, b] = key.split(',');
          detalle += `<div><div style="background:rgb(${r},${g},${b})"></div>${estambre.toFixed(2)} m - $${costo.toFixed(2)} MXN</div>`;
        });
        totalFinal.innerHTML = `TOTAL: $${total.toFixed(2)} MXN`;
      }
      imgInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
          img = new Image();
          img.onload = function () {
            if (img.width < 1000 || img.height < 1000) {
              alert("La imagen debe tener al menos 1000x1000 píxeles.");
              return;
            }
            const factorX = canvas.width / img.width;
            const factorY = canvas.height / img.height;
            scale = Math.min(factorX, factorY, 1);
            imgX = (canvas.width - img.width * scale) / 2;
            imgY = (canvas.height - img.height * scale) / 2;
            draw();
            calcularEstambre();
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });
      canvas.addEventListener('mousedown', e => {
        dragging = true;
        offsetX = e.offsetX - imgX;
        offsetY = e.offsetY - imgY;
      });
      canvas.addEventListener('mousemove', e => {
        if (dragging) {
          imgX = e.offsetX - offsetX;
          imgY = e.offsetY - offsetY;
          draw();
          calcularEstambre();
        }
      });
      canvas.addEventListener('mouseup', () => dragging = false);
      canvas.addEventListener('mouseleave', () => dragging = false);
      canvas.addEventListener('wheel', e => {
        e.preventDefault();
        scale += e.deltaY > 0 ? -0.05 : 0.05;
        if (scale < 0.1) scale = 0.1;
        draw();
        calcularEstambre();
      });
      function centrarImagen() {
        if (!img.src) return;
        imgX = (canvas.width - img.width * scale) / 2;
        imgY = (canvas.height - img.height * scale) / 2;
        draw();
        calcularEstambre();
      }
      let zoomInterval;

      function aplicarZoom(delta) {
        scale += delta;
        if (scale < 0.1) scale = 0.1;
        draw();
        calcularEstambre();
      }

      function iniciarZoom(delta) {
        aplicarZoom(delta);
        zoomInterval = setInterval(() => aplicarZoom(delta), 100); // Cada 100ms
      }

      function detenerZoom() {
        clearInterval(zoomInterval);
      }

      document.getElementById('añadirCarrito').addEventListener('click', () => {
        alert('Producto añadido al carrito');
      });
      window.cargarImagenAlLienzo = function(src) {
        let tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        tempImg.onload = () => {
          img = tempImg;
          const factorX = canvas.width / img.width;
          const factorY = canvas.height / img.height;
          scale = Math.min(factorX, factorY, 1);
          imgX = (canvas.width - img.width * scale) / 2;
          imgY = (canvas.height - img.height * scale) / 2;
          draw();
          requestAnimationFrame(() => {
            calcularEstambre();
            cerrarPlantillas();
          });
        };
        tempImg.onerror = () => {
          let fallbackImg = new Image();
          fallbackImg.onload = () => {
            img = fallbackImg;
            const factorX = canvas.width / img.width;
            const factorY = canvas.height / img.height;
            scale = Math.min(factorX, factorY, 1);
            imgX = (canvas.width - img.width * scale) / 2;
            imgY = (canvas.height - img.height * scale) / 2;
            draw();
            requestAnimationFrame(() => {
              calcularEstambre();
              cerrarPlantillas();
            });
          };
          fallbackImg.src = src;
        };
        tempImg.src = src;
      };
    </script>
    <div class="modal-overlay-plantillas" id="fondoPlantillas" onclick="cerrarPlantillas()"></div>
    <div class="plantillas-modal" id="modalPlantillas"></div>
    <script>
      window.addEventListener("load", () => {
        const wrapper = document.querySelector(".canvas-wrapper");
        if (wrapper) {
           wrapper.scrollLeft = (wrapper.scrollWidth - wrapper.clientWidth) / 2;
        }
      });
    </script>
  </body>
</html>
